---
title: SQLite ä¼šè¯å­˜å‚¨
description: ä½¿ç”¨ SQLite æŒä¹…åŒ– Agent ä¼šè¯ï¼Œé€‚ç”¨äºæ¡Œé¢åº”ç”¨å’Œå•æœºåœºæ™¯
navigation:
  icon: i-lucide-hard-drive
---

# SQLite ä¼šè¯å­˜å‚¨

SQLite ä¼šè¯å­˜å‚¨æ˜¯ Aster ä¸ºæ¡Œé¢åº”ç”¨å’Œå•æœºåœºæ™¯æä¾›çš„è½»é‡çº§æŒä¹…åŒ–æ–¹æ¡ˆï¼Œæ— éœ€å¤–éƒ¨æ•°æ®åº“æœåŠ¡ã€‚

## ğŸ¯ ä¸ºä»€ä¹ˆé€‰æ‹© SQLiteï¼Ÿ

| ç‰¹ç‚¹ | è¯´æ˜ |
|------|------|
| ğŸª¶ **è½»é‡çº§** | æ— éœ€å¤–éƒ¨æ•°æ®åº“æœåŠ¡ |
| ğŸ“ **å•æ–‡ä»¶å­˜å‚¨** | æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨ä¸€ä¸ª `.db` æ–‡ä»¶ä¸­ |
| âš¡ **é«˜æ€§èƒ½** | WAL æ¨¡å¼æä¾›ä¼˜ç§€çš„è¯»å†™æ€§èƒ½ |
| ğŸ”’ **ACID ä¿è¯** | å®Œæ•´çš„äº‹åŠ¡æ”¯æŒ |
| ğŸ”„ **æ¥å£å…¼å®¹** | ä¸ PostgreSQL/MySQL ä½¿ç”¨ç›¸åŒæ¥å£ |

## ğŸ“Š æ¶æ„è®¾è®¡

```mermaid
graph TB
    Desktop[æ¡Œé¢åº”ç”¨] --> Agent[Agent]
    Agent --> SessionService[Session Service]
    SessionService --> SQLite[SQLite Store]
    SQLite --> DBFile[(sessions.db)]

    subgraph "æ•°æ®è¡¨"
        DBFile --> Sessions[sessions è¡¨]
        DBFile --> Events[events è¡¨]
    end

    style SQLite fill:#3b82f6
    style DBFile fill:#10b981
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–

SQLite å­˜å‚¨éœ€è¦ CGO æ”¯æŒï¼š

```bash
# macOS (å·²å†…ç½® SQLite)
go get github.com/mattn/go-sqlite3

# Linux
sudo apt-get install libsqlite3-dev
go get github.com/mattn/go-sqlite3

# Windows (éœ€è¦ GCC)
# å®‰è£… MinGW-w64 å
go get github.com/mattn/go-sqlite3
```

### åŸºæœ¬ä½¿ç”¨

```go
import (
    "github.com/astercloud/aster/pkg/config"
    "github.com/astercloud/aster/pkg/session/sqlite"
)

// ä½¿ç”¨æ ‡å‡†æ•°æ®ç›®å½•
dbPath := config.DatabaseFile("sessions.db")
// macOS: ~/Library/Application Support/aster/sessions.db
// Linux: ~/.local/share/aster/sessions.db
// Windows: %LOCALAPPDATA%\aster\sessions.db

// åˆ›å»º SQLite ä¼šè¯æœåŠ¡
service, err := sqlite.New(dbPath)
if err != nil {
    log.Fatal(err)
}
defer service.Close()
```

### åˆ›å»ºä¼šè¯

```go
ctx := context.Background()

// åˆ›å»ºæ–°ä¼šè¯
sess, err := service.Create(ctx, &session.CreateRequest{
    AppName: "my-desktop-app",
    UserID:  "user-123",
    AgentID: "agent-001",
    Metadata: map[string]any{
        "platform": runtime.GOOS,
        "version":  "1.0.0",
    },
})
if err != nil {
    log.Fatal(err)
}

fmt.Printf("ä¼šè¯ ID: %s\n", sess.ID())
```

### æ·»åŠ æ¶ˆæ¯

```go
// ç”¨æˆ·æ¶ˆæ¯
_, err = sess.AddEvent(ctx, session.AddEventOptions{
    Author:  "user",
    Content: "ä½ å¥½ï¼Œè¯·å¸®æˆ‘åˆ†æä»£ç ",
})

// Agent å“åº”
_, err = sess.AddEvent(ctx, session.AddEventOptions{
    Author:    "assistant",
    Content:   "å¥½çš„ï¼Œæˆ‘æ¥å¸®ä½ åˆ†æä»£ç ...",
    Reasoning: "ç”¨æˆ·è¯·æ±‚ä»£ç åˆ†æï¼Œéœ€è¦å…ˆç†è§£ä»£ç å†…å®¹",
    Actions: []session.Action{
        {
            ToolName: "Read",
            Input:    map[string]any{"path": "main.go"},
            Output:   "package main...",
        },
    },
})
```

### æŸ¥è¯¢å†å²

```go
// éå†æ‰€æœ‰äº‹ä»¶
for event := range sess.Events(ctx, &session.EventsOptions{}) {
    fmt.Printf("[%s] %s\n", event.Author(), event.Content())
}

// è·å–æœ€è¿‘ N æ¡äº‹ä»¶
for event := range sess.Events(ctx, &session.EventsOptions{
    Limit: 10,
}) {
    fmt.Printf("%s: %s\n", event.Author(), event.Content())
}
```

### ä¼šè¯ç®¡ç†

```go
// åˆ—å‡ºæ‰€æœ‰ä¼šè¯
sessions, err := service.List(ctx, &session.ListRequest{
    AppName: "my-desktop-app",
    UserID:  "user-123",
})

for _, s := range sessions {
    fmt.Printf("- %s (Agent: %s)\n", s.ID(), s.AgentID())
}

// è·å–ç‰¹å®šä¼šè¯
sess, err := service.Get(ctx, &session.GetRequest{
    AppName:   "my-desktop-app",
    UserID:    "user-123",
    SessionID: "session-id",
})

// åˆ é™¤ä¼šè¯
err = service.Delete(ctx, &session.DeleteRequest{
    AppName:   "my-desktop-app",
    UserID:    "user-123",
    SessionID: "session-id",
})
```

## ğŸ“ æ•°æ®åº“ç»“æ„

### sessions è¡¨

```sql
CREATE TABLE sessions (
    id TEXT PRIMARY KEY,
    app_name TEXT NOT NULL,
    user_id TEXT NOT NULL,
    agent_id TEXT NOT NULL,
    metadata TEXT,  -- JSON æ ¼å¼
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_sessions_app_user ON sessions(app_name, user_id);
CREATE INDEX idx_sessions_updated ON sessions(updated_at DESC);
```

### events è¡¨

```sql
CREATE TABLE events (
    id TEXT PRIMARY KEY,
    session_id TEXT NOT NULL,
    invocation_id TEXT,
    agent_id TEXT,
    branch TEXT,
    author TEXT,
    content TEXT,
    reasoning TEXT,
    actions TEXT,  -- JSON æ ¼å¼
    long_running_tool_ids TEXT,
    metadata TEXT,  -- JSON æ ¼å¼
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (session_id) REFERENCES sessions(id) ON DELETE CASCADE
);

CREATE INDEX idx_events_session ON events(session_id);
CREATE INDEX idx_events_created ON events(created_at);
```

## âš™ï¸ é…ç½®é€‰é¡¹

SQLite ä½¿ç”¨ WAL (Write-Ahead Logging) æ¨¡å¼ï¼Œæä¾›æ›´å¥½çš„å¹¶å‘æ€§èƒ½ï¼š

```go
// è¿æ¥å­—ç¬¦ä¸²å‚æ•°
// ?_journal_mode=WAL  - å¯ç”¨ WAL æ¨¡å¼
// &_busy_timeout=5000 - ç­‰å¾…é”è¶…æ—¶ 5 ç§’

db, err := sql.Open("sqlite3", dbPath+"?_journal_mode=WAL&_busy_timeout=5000")
```

### WAL æ¨¡å¼ä¼˜åŠ¿

- âœ… è¯»å†™å¯ä»¥å¹¶å‘è¿›è¡Œ
- âœ… å†™æ“ä½œä¸é˜»å¡è¯»æ“ä½œ
- âœ… æ›´å¿«çš„å†™å…¥æ€§èƒ½
- âœ… æ›´å¥½çš„å´©æºƒæ¢å¤

## ğŸ”„ ä¸å…¶ä»–å­˜å‚¨çš„å¯¹æ¯”

| ç‰¹æ€§ | SQLite | PostgreSQL | MySQL | Memory |
|------|--------|------------|-------|--------|
| éƒ¨ç½²å¤æ‚åº¦ | â­ æœ€ç®€å• | â­â­â­ | â­â­â­ | â­ æœ€ç®€å• |
| æ•°æ®æŒä¹…åŒ– | âœ… | âœ… | âœ… | âŒ |
| å¹¶å‘æ€§èƒ½ | â­â­ | â­â­â­ | â­â­â­ | â­â­â­ |
| JSON æŸ¥è¯¢ | åŸºæœ¬æ”¯æŒ | JSONB | JSON | åŸç”Ÿ |
| é€‚ç”¨åœºæ™¯ | æ¡Œé¢/å•æœº | æœåŠ¡å™¨ | æœåŠ¡å™¨ | å¼€å‘æµ‹è¯• |

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä½¿ç”¨æ ‡å‡†è·¯å¾„

```go
import "github.com/astercloud/aster/pkg/config"

// æ¨èï¼šä½¿ç”¨è·¨å¹³å°æ ‡å‡†è·¯å¾„
dbPath := config.DatabaseFile("sessions.db")

// ä¸æ¨èï¼šç¡¬ç¼–ç è·¯å¾„
// dbPath := "/Users/me/data/sessions.db"
```

### 2. å®šæœŸç»´æŠ¤

```go
// æ¸…ç†æ—§ä¼šè¯
func cleanupOldSessions(service *sqlite.Service, maxAge time.Duration) error {
    ctx := context.Background()
    sessions, _ := service.List(ctx, &session.ListRequest{
        AppName: "my-app",
        UserID:  "user-123",
    })

    cutoff := time.Now().Add(-maxAge)
    for _, sess := range sessions {
        if sess.UpdatedAt().Before(cutoff) {
            service.Delete(ctx, &session.DeleteRequest{
                AppName:   "my-app",
                UserID:    "user-123",
                SessionID: sess.ID(),
            })
        }
    }
    return nil
}
```

### 3. å¤‡ä»½æ•°æ®

```bash
# SQLite æ•°æ®åº“å¯ä»¥ç›´æ¥å¤åˆ¶
cp ~/.local/share/aster/sessions.db backup/sessions.db

# æˆ–ä½¿ç”¨ sqlite3 å‘½ä»¤
sqlite3 ~/.local/share/aster/sessions.db ".backup backup/sessions.db"
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Session æŒä¹…åŒ–](/core-concepts/session-persistence) - PostgreSQL/MySQL å­˜å‚¨
- [è·¨å¹³å°è·¯å¾„](/deployment/desktop/paths) - è·¯å¾„ç®¡ç†ç³»ç»Ÿ
- [æ¡Œé¢åº”ç”¨éƒ¨ç½²](/deployment/desktop) - æ¡Œé¢æ¡†æ¶é›†æˆ

## ğŸ”— ç¤ºä¾‹ä»£ç 

å®Œæ•´ç¤ºä¾‹è¯·å‚è€ƒï¼š

```bash
go run ./examples/session-sqlite/
```

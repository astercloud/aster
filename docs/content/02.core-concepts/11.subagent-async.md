---
title: SubAgent å¼‚æ­¥æ‰§è¡Œ
description: å¼‚æ­¥æ‰§è¡Œã€çŠ¶æ€æŸ¥è¯¢ã€Resume æœºåˆ¶è¯¦è§£
navigation:
  icon: i-lucide-timer
---

# SubAgent å¼‚æ­¥æ‰§è¡Œ

v0.12.2+ æ–°å¢çš„å¼‚æ­¥æ‰§è¡ŒåŠŸèƒ½ï¼Œè®© SubAgent å¯ä»¥åœ¨åå°é•¿æ—¶é—´è¿è¡Œï¼Œä¸» Agent æ— éœ€ç­‰å¾…ã€‚

## ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥æ‰§è¡Œï¼Ÿ

### é—®é¢˜åœºæ™¯

**åŒæ­¥æ‰§è¡Œçš„é™åˆ¶**ï¼š

```go
// ä¸» Agent å¿…é¡»ç­‰å¾… SubAgent å®Œæˆ
result := subagent.Execute(ctx, "åˆ†æå¤§å‹æ•°æ®é›†")  // é˜»å¡ 10 åˆ†é’Ÿ
// ä¸» Agent æ— æ³•åšå…¶ä»–äº‹æƒ…
```

**å¼‚æ­¥æ‰§è¡Œçš„ä¼˜åŠ¿**ï¼š

```go
// ä¸» Agent ç«‹å³è¿”å›ï¼ŒSubAgent åœ¨åå°è¿è¡Œ
taskID := subagent.ExecuteAsync(ctx, "åˆ†æå¤§å‹æ•°æ®é›†")  // ç«‹å³è¿”å›
// ä¸» Agent å¯ä»¥ç»§ç»­å¤„ç†å…¶ä»–ä»»åŠ¡
// ç¨åæŸ¥è¯¢ç»“æœ
result := subagent.Query(taskID)
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯ç”¨å¼‚æ­¥æ‰§è¡Œ

```go
subagentMW, _ := middleware.NewSubAgentMiddleware(&middleware.SubAgentMiddlewareConfig{
    Specs:       specs,
    Factory:     factory,
    EnableAsync: true,  // å¯ç”¨å¼‚æ­¥æ‰§è¡Œ
    DefaultTimeout: 30 * time.Minute,
})
```

### 2. å¼‚æ­¥å¯åŠ¨ä»»åŠ¡

```go
// ä½¿ç”¨ task å·¥å…·ï¼Œè®¾ç½® async=true
result, _ := ag.Chat(ctx, `
tool_use:
  name: task
  parameters:
    description: "æ·±åº¦åˆ†æç”¨æˆ·è¡Œä¸ºæ•°æ®ï¼Œç”Ÿæˆè¯¦ç»†æŠ¥å‘Š"
    subagent_type: data-analyst
    async: true
    timeout: 1800  # 30åˆ†é’Ÿè¶…æ—¶
`)

// ç«‹å³è¿”å› task_id
// {
//   "ok": true,
//   "task_id": "subagent_1234567890",
//   "status": "starting",
//   "message": "SubAgent started in background..."
// }
```

### 3. æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€

```go
// ä½¿ç”¨ query_subagent å·¥å…·
result, _ := ag.Chat(ctx, `
tool_use:
  name: query_subagent
  parameters:
    task_id: "subagent_1234567890"
`)

// è¿”å›è¯¦ç»†çŠ¶æ€
// {
//   "ok": true,
//   "task_id": "subagent_1234567890",
//   "status": "running",
//   "duration": 120.5,
//   "resource_usage": {
//     "memory_mb": 256.5,
//     "cpu_percent": 45.2
//   }
// }
```

### 4. è·å–ç»“æœ

```go
// å½“ status ä¸º "completed" æ—¶ï¼Œoutput å­—æ®µåŒ…å«ç»“æœ
// {
//   "ok": true,
//   "task_id": "subagent_1234567890",
//   "status": "completed",
//   "output": "åˆ†ææŠ¥å‘Šï¼š...",
//   "duration": 1800.0
// }
```

## ğŸ“Š å®Œæ•´å·¥ä½œæµ

### åœºæ™¯ï¼šå¹¶è¡Œåˆ†æå¤šä¸ªæ•°æ®æº

```go
// 1. å¯åŠ¨å¤šä¸ªå¼‚æ­¥ä»»åŠ¡
task1 := startTask("åˆ†ææ•°æ®æºA")
task2 := startTask("åˆ†ææ•°æ®æºB")
task3 := startTask("åˆ†ææ•°æ®æºC")

// 2. ä¸» Agent ç»§ç»­å…¶ä»–å·¥ä½œ
doOtherWork()

// 3. è½®è¯¢æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
for {
    status1 := queryTask(task1)
    status2 := queryTask(task2)
    status3 := queryTask(task3)

    if allCompleted(status1, status2, status3) {
        break
    }

    sleep(10 * time.Second)
}

// 4. æ”¶é›†ç»“æœ
result1 := getOutput(task1)
result2 := getOutput(task2)
result3 := getOutput(task3)

// 5. æ•´åˆåˆ†æ
finalReport := synthesize(result1, result2, result3)
```

## ğŸ”§ ç®¡ç†å·¥å…·è¯¦è§£

### 1. query_subagent

**åŠŸèƒ½**ï¼šæŸ¥è¯¢å­ä»£ç†çš„çŠ¶æ€å’Œè¾“å‡º

**å‚æ•°**ï¼š

```typescript
{
  task_id: string; // ä»»åŠ¡ ID
}
```

**è¿”å›**ï¼š

```typescript
{
    ok: boolean,
    task_id: string,
    subagent_type: string,
    status: string,  // "starting" | "running" | "completed" | "failed" | "stopped" | "timeout"
    start_time: string,
    end_time?: string,
    duration: number,  // ç§’
    output?: string,   // è¾“å‡ºç»“æœï¼ˆcompleted æ—¶ï¼‰
    error?: string,    // é”™è¯¯ä¿¡æ¯ï¼ˆfailed æ—¶ï¼‰
    exit_code?: number,
    resource_usage?: {
        memory_mb: number,
        cpu_percent: number
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```go
tool_use:
  name: query_subagent
  parameters:
    task_id: "subagent_1234567890"
```

---

### 2. stop_subagent

**åŠŸèƒ½**ï¼šåœæ­¢æ­£åœ¨è¿è¡Œçš„å­ä»£ç†

**å‚æ•°**ï¼š

```typescript
{
  task_id: string; // ä»»åŠ¡ ID
}
```

**è¿”å›**ï¼š

```typescript
{
    ok: boolean,
    task_id: string,
    message: string
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š

- ä»»åŠ¡è¿è¡Œæ—¶é—´è¿‡é•¿ï¼Œéœ€è¦æ‰‹åŠ¨åœæ­¢
- å‘ç°ä»»åŠ¡æ‰§è¡Œæ–¹å‘é”™è¯¯ï¼Œéœ€è¦ä¸­æ­¢
- èµ„æºç´§å¼ ï¼Œéœ€è¦é‡Šæ”¾èµ„æº

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```go
tool_use:
  name: stop_subagent
  parameters:
    task_id: "subagent_1234567890"
```

---

### 3. resume_subagent

**åŠŸèƒ½**ï¼šæ¢å¤å·²åœæ­¢æˆ–å¤±è´¥çš„å­ä»£ç†

**å‚æ•°**ï¼š

```typescript
{
  task_id: string; // åŸä»»åŠ¡ ID
}
```

**è¿”å›**ï¼š

```typescript
{
    ok: boolean,
    old_task_id: string,
    new_task_id: string,  // æ–°çš„ä»»åŠ¡ ID
    subagent_type: string,
    status: string,
    message: string
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š

- å­ä»£ç†å› è¶…æ—¶æˆ–é”™è¯¯è€Œåœæ­¢ï¼Œéœ€è¦é‡æ–°æ‰§è¡Œ
- æ‰‹åŠ¨åœæ­¢çš„å­ä»£ç†ï¼Œéœ€è¦ç»§ç»­æ‰§è¡Œ
- ç³»ç»Ÿé‡å¯åï¼Œæ¢å¤æœªå®Œæˆçš„ä»»åŠ¡

**æ³¨æ„äº‹é¡¹**ï¼š

- æ¢å¤åä¼šç”Ÿæˆæ–°çš„ task_id
- åŸæœ‰çš„å…ƒæ•°æ®ä¼šè¢«ä¿ç•™
- åªèƒ½æ¢å¤çŠ¶æ€ä¸º "stopped"ã€"failed" æˆ– "completed" çš„å­ä»£ç†

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```go
tool_use:
  name: resume_subagent
  parameters:
    task_id: "subagent_1234567890"
```

---

### 4. list_subagents

**åŠŸèƒ½**ï¼šåˆ—å‡ºæ‰€æœ‰å­ä»£ç†ä»»åŠ¡

**å‚æ•°**ï¼š

```typescript
{
    status_filter?: string  // å¯é€‰ï¼ŒæŒ‰çŠ¶æ€è¿‡æ»¤
}
```

**è¿”å›**ï¼š

```typescript
{
    ok: boolean,
    count: number,
    subagents: Array<{
        task_id: string,
        subagent_type: string,
        status: string,
        start_time: string,
        end_time?: string,
        duration: number,
        error?: string
    }>
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š

- æŸ¥çœ‹å½“å‰æœ‰å“ªäº›å­ä»£ç†æ­£åœ¨è¿è¡Œ
- æ£€æŸ¥å†å²ä»»åŠ¡çš„æ‰§è¡Œæƒ…å†µ
- æ¸…ç†å·²å®Œæˆçš„ä»»åŠ¡

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```go
# åˆ—å‡ºæ‰€æœ‰ä»»åŠ¡
tool_use:
  name: list_subagents

# åªåˆ—å‡ºæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡
tool_use:
  name: list_subagents
  parameters:
    status_filter: "running"
```

## ğŸ¯ ä½¿ç”¨æ¨¡å¼

### æ¨¡å¼ 1ï¼šFire and Forget

**åœºæ™¯**ï¼šå¯åŠ¨ä»»åŠ¡åä¸å…³å¿ƒç»“æœ

```go
// å¯åŠ¨ä»»åŠ¡
startTask("æ¸…ç†ä¸´æ—¶æ–‡ä»¶")

// ä¸ç­‰å¾…ï¼Œç»§ç»­å…¶ä»–å·¥ä½œ
```

### æ¨¡å¼ 2ï¼šPolling

**åœºæ™¯**ï¼šå®šæœŸæ£€æŸ¥ä»»åŠ¡çŠ¶æ€

```go
taskID := startTask("é•¿æ—¶é—´åˆ†æ")

// è½®è¯¢æ£€æŸ¥
for {
    status := queryTask(taskID)
    if status == "completed" {
        result := getOutput(taskID)
        break
    }
    sleep(10 * time.Second)
}
```

### æ¨¡å¼ 3ï¼šBatch Processing

**åœºæ™¯**ï¼šæ‰¹é‡å¤„ç†å¤šä¸ªä»»åŠ¡

```go
// å¯åŠ¨æ‰€æœ‰ä»»åŠ¡
taskIDs := []string{}
for _, item := range items {
    taskID := startTask("å¤„ç† " + item)
    taskIDs = append(taskIDs, taskID)
}

// ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
for {
    allDone := true
    for _, taskID := range taskIDs {
        status := queryTask(taskID)
        if status != "completed" {
            allDone = false
            break
        }
    }
    if allDone {
        break
    }
    sleep(10 * time.Second)
}

// æ”¶é›†æ‰€æœ‰ç»“æœ
results := []string{}
for _, taskID := range taskIDs {
    result := getOutput(taskID)
    results = append(results, result)
}
```

### æ¨¡å¼ 4ï¼šRetry on Failure

**åœºæ™¯**ï¼šä»»åŠ¡å¤±è´¥åè‡ªåŠ¨é‡è¯•

```go
taskID := startTask("ä¸ç¨³å®šçš„ä»»åŠ¡")

maxRetries := 3
for i := 0; i < maxRetries; i++ {
    // ç­‰å¾…å®Œæˆ
    waitForCompletion(taskID)

    status := queryTask(taskID)
    if status == "completed" {
        result := getOutput(taskID)
        break
    } else if status == "failed" {
        // é‡è¯•
        taskID = resumeTask(taskID)
    }
}
```

## âš™ï¸ é«˜çº§é…ç½®

### 1. è¶…æ—¶æ§åˆ¶

```go
// å…¨å±€é»˜è®¤è¶…æ—¶
subagentMW, _ := middleware.NewSubAgentMiddleware(&middleware.SubAgentMiddlewareConfig{
    EnableAsync:    true,
    DefaultTimeout: 30 * time.Minute,  // é»˜è®¤ 30 åˆ†é’Ÿ
})

// å•ä¸ªä»»åŠ¡è¶…æ—¶
tool_use:
  name: task
  parameters:
    description: "å¿«é€Ÿä»»åŠ¡"
    subagent_type: quick-agent
    async: true
    timeout: 300  # 5 åˆ†é’Ÿè¶…æ—¶
```

### 2. è¿›ç¨‹çº§éš”ç¦»

```go
// å¯ç”¨è¿›ç¨‹çº§éš”ç¦»ï¼ˆæ›´å®‰å…¨ï¼Œä½†å¼€é”€æ›´å¤§ï¼‰
subagentMW, _ := middleware.NewSubAgentMiddleware(&middleware.SubAgentMiddlewareConfig{
    EnableAsync:            true,
    EnableProcessIsolation: true,  // æ¯ä¸ª SubAgent è¿è¡Œåœ¨ç‹¬ç«‹è¿›ç¨‹ä¸­
})
```

### 3. è‡ªå®šä¹‰ç®¡ç†å™¨

```go
// ä½¿ç”¨è‡ªå®šä¹‰çš„ SubagentManager
customManager := myCustomSubagentManager()

subagentMW, _ := middleware.NewSubAgentMiddleware(&middleware.SubAgentMiddlewareConfig{
    Manager:     customManager,
    EnableAsync: true,
})
```

## ğŸ“Š çŠ¶æ€è¯´æ˜

| çŠ¶æ€          | è¯´æ˜           | å¯æ‰§è¡Œæ“ä½œ    |
| ------------- | -------------- | ------------- |
| **starting**  | æ­£åœ¨å¯åŠ¨       | query         |
| **running**   | æ­£åœ¨è¿è¡Œ       | query, stop   |
| **completed** | å·²å®Œæˆï¼ˆæˆåŠŸï¼‰ | query, resume |
| **failed**    | æ‰§è¡Œå¤±è´¥       | query, resume |
| **stopped**   | å·²åœæ­¢         | query, resume |
| **timeout**   | è¶…æ—¶           | query, resume |

## ğŸ“ æœ€ä½³å®è·µ

### 1. åˆç†è®¾ç½®è¶…æ—¶

```go
// âœ… æ ¹æ®ä»»åŠ¡ç±»å‹è®¾ç½®åˆç†çš„è¶…æ—¶
- å¿«é€Ÿä»»åŠ¡: 5-10 åˆ†é’Ÿ
- ä¸­ç­‰ä»»åŠ¡: 30 åˆ†é’Ÿ
- é•¿æ—¶é—´ä»»åŠ¡: 1-2 å°æ—¶

// âŒ é¿å…
- è¶…æ—¶è¿‡çŸ­ï¼šä»»åŠ¡è¿˜æ²¡å®Œæˆå°±è¢«æ€æ­»
- è¶…æ—¶è¿‡é•¿ï¼šå ç”¨èµ„æºè¿‡ä¹…
```

### 2. è½®è¯¢é—´éš”

```go
// âœ… æ ¹æ®ä»»åŠ¡é¢„æœŸæ—¶é—´è®¾ç½®è½®è¯¢é—´éš”
- å¿«é€Ÿä»»åŠ¡ï¼ˆ< 1åˆ†é’Ÿï¼‰: æ¯ 5 ç§’æŸ¥è¯¢ä¸€æ¬¡
- ä¸­ç­‰ä»»åŠ¡ï¼ˆ1-10åˆ†é’Ÿï¼‰: æ¯ 30 ç§’æŸ¥è¯¢ä¸€æ¬¡
- é•¿æ—¶é—´ä»»åŠ¡ï¼ˆ> 10åˆ†é’Ÿï¼‰: æ¯ 1-2 åˆ†é’ŸæŸ¥è¯¢ä¸€æ¬¡

// âŒ é¿å…
- è½®è¯¢è¿‡é¢‘ï¼šæµªè´¹èµ„æº
- è½®è¯¢è¿‡æ…¢ï¼šå“åº”ä¸åŠæ—¶
```

### 3. é”™è¯¯å¤„ç†

```go
// âœ… æ£€æŸ¥ä»»åŠ¡çŠ¶æ€å¹¶å¤„ç†é”™è¯¯
status := queryTask(taskID)
if status == "failed" {
    error := getError(taskID)
    log.Printf("Task failed: %s", error)

    // å†³å®šæ˜¯å¦é‡è¯•
    if isRetryable(error) {
        resumeTask(taskID)
    }
}

// âŒ é¿å…
- å‡è®¾ä»»åŠ¡æ€»æ˜¯æˆåŠŸ
- ä¸æ£€æŸ¥é”™è¯¯ä¿¡æ¯
```

### 4. èµ„æºæ¸…ç†

```go
// âœ… åŠæ—¶æ¸…ç†å·²å®Œæˆçš„ä»»åŠ¡
completedTasks := listTasks(status="completed")
for _, taskID := range completedTasks {
    cleanupTask(taskID)
}

// âŒ é¿å…
- è®©å·²å®Œæˆçš„ä»»åŠ¡ä¸€ç›´å ç”¨èµ„æº
- ä¸æ¸…ç†å¤±è´¥çš„ä»»åŠ¡
```

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šä»»åŠ¡ä¸€ç›´å¤„äº "starting" çŠ¶æ€

**å¯èƒ½åŸå› **ï¼š

- SubAgent å¯åŠ¨å¤±è´¥
- èµ„æºä¸è¶³
- é…ç½®é”™è¯¯

**è§£å†³æ–¹æ³•**ï¼š

```go
// æŸ¥è¯¢è¯¦ç»†çŠ¶æ€
status := queryTask(taskID)
if status.Error != "" {
    log.Printf("Error: %s", status.Error)
}

// æ£€æŸ¥èµ„æºä½¿ç”¨
if status.ResourceUsage != nil {
    log.Printf("Memory: %.2f MB, CPU: %.2f%%",
        status.ResourceUsage.MemoryMB,
        status.ResourceUsage.CPUPercent)
}
```

### é—®é¢˜ 2ï¼šä»»åŠ¡è¶…æ—¶

**å¯èƒ½åŸå› **ï¼š

- ä»»åŠ¡å¤æ‚åº¦è¶…å‡ºé¢„æœŸ
- è¶…æ—¶è®¾ç½®è¿‡çŸ­
- èµ„æºä¸è¶³å¯¼è‡´æ‰§è¡Œç¼“æ…¢

**è§£å†³æ–¹æ³•**ï¼š

```go
// å¢åŠ è¶…æ—¶æ—¶é—´
tool_use:
  name: task
  parameters:
    timeout: 7200  # å¢åŠ åˆ° 2 å°æ—¶

// æˆ–è€…æ¢å¤ä»»åŠ¡
resumeTask(taskID)
```

### é—®é¢˜ 3ï¼šæ— æ³•æ¢å¤ä»»åŠ¡

**å¯èƒ½åŸå› **ï¼š

- ä»»åŠ¡çŠ¶æ€ä¸å…è®¸æ¢å¤
- ä»»åŠ¡å·²è¢«æ¸…ç†

**è§£å†³æ–¹æ³•**ï¼š

```go
// æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
status := queryTask(taskID)
if status.Status == "running" {
    // å…ˆåœæ­¢å†æ¢å¤
    stopTask(taskID)
    time.Sleep(1 * time.Second)
    resumeTask(taskID)
}
```

## ğŸ“š ç›¸å…³èµ„æº

- [SubAgent ç³»ç»Ÿ](/core-concepts/subagent-system) - åŸºç¡€æ¦‚å¿µ
- [SubAgent å¯¹æ¯”åˆ†æ](/multi-agent/subagent-comparison) - ä¸ Claude Codex å¯¹æ¯”
- [å¼‚æ­¥æ‰§è¡Œç¤ºä¾‹](/examples/subagent-async) - å®Œæ•´ä»£ç ç¤ºä¾‹
- [API å‚è€ƒ](/api-reference/subagent) - å®Œæ•´ API æ–‡æ¡£

## ğŸ‰ æ€»ç»“

å¼‚æ­¥æ‰§è¡ŒåŠŸèƒ½è®© SubAgent ç³»ç»Ÿæ›´åŠ å¼ºå¤§ï¼š

- âœ… **éé˜»å¡**ï¼šä¸» Agent æ— éœ€ç­‰å¾…
- âœ… **é•¿æ—¶é—´è¿è¡Œ**ï¼šæ”¯æŒæ•°å°æ—¶çš„ä»»åŠ¡
- âœ… **çŠ¶æ€æŸ¥è¯¢**ï¼šéšæ—¶äº†è§£ä»»åŠ¡è¿›åº¦
- âœ… **Resume æœºåˆ¶**ï¼šå¤±è´¥åå¯æ¢å¤
- âœ… **èµ„æºç›‘æ§**ï¼šå®æ—¶ç›‘æ§èµ„æºä½¿ç”¨
- âœ… **çµæ´»æ§åˆ¶**ï¼šåœæ­¢ã€æ¢å¤ã€æ¸…ç†

è¿™ä½¿å¾— Aster çš„ SubAgent ç³»ç»Ÿè¾¾åˆ°äº†ä¸ Claude Codex ç›¸å½“çš„åŠŸèƒ½å®Œæ•´åº¦ï¼
